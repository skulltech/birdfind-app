-- Long running background jobs

-- Rate limit information

create table if not exists twitter_api_rate_limit (
  user_twitter_id bigint references twitter_profile not null,
  endpoint text not null check (endpoint in (
    'lookup-followers', 'lookup-following', 'lookup-blocking', 'lookup-muting',
    'add-list-member', 'remove-list-member',
    'add-follow', 'remove-follow', 'add-block', 'remove-block', 'add-mute', 'remove-mute'
  )),
  created_at timestamp with time zone default now() not null,
  resets_at timestamp with time zone not null,

  primary key (user_twitter_id, endpoint)
);

alter table twitter_api_rate_limit enable row level security;


-- Lookup relation jobs

create table if not exists lookup_relation_job (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default now() not null,
    updated_at timestamp with time zone default now() not null,

    -- Actual inputs
    user_id uuid references auth.users not null,
    target_id bigint references twitter_profile not null,
    relation text not null check (relation in ('followers', 'following', 'blocking', 'muting')),
    priority integer not null,

    -- To track progress
    paused boolean default false not null,
    finished boolean default false not null,
    deleted boolean default false not null,
    pagination_token text,
    updated_count integer default 0 not null
);

alter table lookup_relation_job enable row level security;

create policy "Users can create lookup-relation jobs that will use their own tokens"
  on lookup_relation_job for insert
  with check ( auth.uid() = user_id );

create policy "lookup-relation Jobs are viewable by users who created them"
  on lookup_relation_job for select
  using ( auth.uid() = user_id );

create policy "Users can update lookup-relation jobs they created"
  on lookup_relation_job for update
  using ( auth.uid() = user_id );


-- Manage list members jobs

create table if not exists manage_list_members_job (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default now() not null,
    updated_at timestamp with time zone default now() not null,

    -- Actual inputs
    user_id uuid references auth.users not null,
    add boolean not null,
    member_ids bigint[] not null,
    list_id bigint references twitter_list not null,
    priority integer not null,

    -- To track progress
    paused boolean default false not null,
    finished boolean generated always as (member_ids_done @> member_ids) stored,
    deleted boolean default false not null,
    member_ids_done bigint[] default array[]::bigint[]
);

alter table manage_list_members_job enable row level security;

create policy "Users can create manage-list-members jobs that will use their own tokens"
  on manage_list_members_job for insert
  with check ( auth.uid() = user_id );

create policy "manage-list-members Jobs are viewable by users who created them"
  on manage_list_members_job for select
  using ( auth.uid() = user_id );

create policy "Users can update manage-list-members jobs they created"
  on manage_list_members_job for update
  using ( auth.uid() = user_id );


-- Manage relation jobs

create table if not exists manage_relation_job (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default now() not null,
    updated_at timestamp with time zone default now() not null,

    -- Actual inputs
    user_id uuid references auth.users not null,
    target_ids bigint[] not null,
    relation text check (relation in ('follow', 'mute', 'block')),
    add boolean not null,
    priority integer not null,

    -- To track progress
    paused boolean default false not null,
    finished boolean generated always as (target_ids_done @> target_ids) stored,
    deleted boolean default false not null,
    target_ids_done bigint[] default array[]::bigint[]
);

-- Function to get the next lookup-relation jobs to execute

create or replace function get_lookup_relation_jobs_to_add(active_jobs bigint[], failed_jobs bigint[])
  returns setof lookup_relation_job as $$

select
  distinct on (lookup_relation_job.user_id, lookup_relation_job.relation)
  lookup_relation_job.*
from lookup_relation_job
  left join user_profile on user_profile.id = lookup_relation_job.user_id
  left join twitter_api_rate_limit on 
    twitter_api_rate_limit.user_twitter_id = user_profile.twitter_id and
    twitter_api_rate_limit.endpoint = 'lookup-' || lookup_relation_job.relation

where lookup_relation_job.finished = false
  and lookup_relation_job.paused = false
  and lookup_relation_job.deleted = false
  and not (lookup_relation_job.id = any(failed_jobs))
  and (twitter_api_rate_limit.resets_at is null or twitter_api_rate_limit.resets_at < now())
  and lookup_relation_job.user_id not in (
    select user_id from lookup_relation_job where id = any(active_jobs)
  )
order by lookup_relation_job.user_id, lookup_relation_job.relation, lookup_relation_job.priority desc
;

$$ language sql;


-- Function to get the next manage-relation jobs to execute

create or replace function get_manage_relation_jobs_to_add(active_jobs bigint[], failed_jobs bigint[])
  returns setof manage_relation_job as $$

select
  distinct on (manage_relation_job.user_id, manage_relation_job.relation, manage_relation_job.add)
  manage_relation_job.*
from manage_relation_job
  left join user_profile on user_profile.id = manage_relation_job.user_id
  left join twitter_api_rate_limit on 
    twitter_api_rate_limit.user_twitter_id = user_profile.twitter_id and
    twitter_api_rate_limit.endpoint =
      case manage_relation_job.add when true then 'add' else 'remove' end || '-' || manage_relation_job.relation

where manage_relation_job.finished = false
  and manage_relation_job.paused = false
  and manage_relation_job.deleted = false
  and not (manage_relation_job.id = any(failed_jobs))
  and (twitter_api_rate_limit.resets_at is null or twitter_api_rate_limit.resets_at < now())
  and manage_relation_job.user_id not in (
    select user_id from manage_relation_job where id = any(active_jobs)
  )
order by manage_relation_job.user_id, manage_relation_job.relation, manage_relation_job.add, manage_relation_job.priority desc
;

$$ language sql;


-- Function to get the next manage-list-members jobs to execute

create or replace function get_manage_list_members_jobs_to_add(active_jobs bigint[], failed_jobs bigint[])
  returns setof manage_list_members_job as $$

select
  distinct on (manage_list_members_job.user_id, manage_list_members_job.add)
  manage_list_members_job.*
from manage_list_members_job
  left join user_profile on user_profile.id = manage_list_members_job.user_id
  left join twitter_api_rate_limit on 
    twitter_api_rate_limit.user_twitter_id = user_profile.twitter_id and
    twitter_api_rate_limit.endpoint = 
      case manage_list_members_job.add when true then 'add' else 'remove' end || '-list-member'

where manage_list_members_job.finished = false
  and manage_list_members_job.paused = false
  and manage_list_members_job.deleted = false
  and (twitter_api_rate_limit.resets_at is null or twitter_api_rate_limit.resets_at < now())
  and not (manage_list_members_job.id = any(failed_jobs))
  and manage_list_members_job.user_id not in (
    select user_id from manage_list_members_job where id = any(active_jobs)
  )
order by manage_list_members_job.user_id, manage_list_members_job.add, manage_list_members_job.priority desc
;

$$ language sql;
